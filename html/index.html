<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<link rel="stylesheet" href="../css/index.css">
		<link rel="stylesheet" href="../node_modules/datetimepicker/dist/DateTimePicker.min.css">
		<script type="text/javascript" src="../node_modules/jquery/dist/jquery.min.js"></script>
		<script type="text/javascript" src="../node_modules/datetimepicker/dist/DateTimePicker.min.js"></script>
	</head>
	<body>
		<div class="pagewrapper">
			<div class="page holiday">
				<div class="header">填写假期日期</div>
				<div class="content">
					<div class="section">
						<div class="subject">回家日期</div>
						<div class="item">
							<input type="text" id="start" class="time start" data-field="date" data-startend="start" data-startendelem=".end" readonly>
						</div>
					</div>
					<div class="section">
						<div class="subject">离家日期</div>
						<div class="item">
							<input type="text" id="end" class="time end" data-field="date" data-startend="end" data-startendelem=".start" readonly>
						</div>
					</div>
					<div id="dtBox"></div>
					<div class="info">
						假期共计
						<span class="total">?</span>
						天
					</div>
				</div>
			</div>
			<div class="page arrangement">
				<div class="header">假期活动安排</div>
				<div class="section classmates">
					<div class="subject">同学聚会</div>
				</div>
				<div class="section friends">
					<div class="subject">走亲访友</div>
				</div>
				<div class="section own">
					<div class="subject">自己专属</div>
				</div>
			</div>
			<div class="page result">
				<div class="header">Family Time</div>
				<div class="info">
					能陪伴父母的时间
					只剩
				</div>
				<div class="remain">
					<span class="days">?</span>天<span class="hours">?</span>小时
				</div>
				<div class="info">
					仅仅的<div class="percent"><span class="numerator">?</span><span class="denominator">365</span></div>
				</div>
			</div>
			<div class="page film">
				<div class="header">电影时光</div>
				<div class="info">父母陪你做了那么多事，你陪父母做过什么？</div>
				<div class="info">趁假期，贺岁档，陪父母看场电影吧！</div>
				<a class="buy" href="#">百度购电影票家庭套餐</a>
			</div>
		</div>
		<script>
			$(function(){
				var width = 0;
				var startX = 0;
				var offsetX = 0;
				var offset = 0;
				var total = 0;
				var config = {
					classmates: {
						party: {freq: 7, time: 5, name: '聚会'},
						KTV: {freq: 7, time: 5, name: 'KTV'},
						travel: {freq: 7, time: 6, name: '出游'},
						shopping: {freq: 7, time: 8, name: '逛街'}
					},
					friends: {
						kinsman: {freq: 5, time: 8, name: '串亲戚'},
						date: {freq: 4, time: 12, name: '相亲'},
						blabla: {freq: 7, time: 4, name: '陪七大姑聊人生'}
					},
					own: {
						mobile: {freq: 1, time: 5, name: '手机党'},
						sleep: {freq: 1, time: 8, name: '睡眠'},
						traffic: {freq: 0, time: 30, name: '春运'}
					}
				};
				var tpl = '<div class="item"><label><input type="checkbox" class="$type" data-type="$subject">$name</label><span></span></div>';

				function init() {
					$('.page').each(function(index, el) {
						$(el).css('left', index+'00%');
					});
					$('.page').eq(0).addClass('current');

					$('#dtBox').DateTimePicker({
						shortMonthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
						formatHumanDate: function(date) {return date.monthShort + " " + date.dd + ", " + date.yyyy;},
						dateFormat: "yyyy-MM-dd"
					});
					$('.time').change(function(event) {
						updateTotal();
					});
					initArrangements();
					$('.arrangement input').click(function(event) {
						updateTime($(event.target));
					});
					$('.pagewrapper').show();
					width = $('.pagewrapper').width();
				}

				function initArrangements() {
					$('.arrangement .section').each(function(index, el) {
						var subject = $(el).attr('class').replace('section', '').trim();
						if (!(subject in config)) { return; }
						for (var item in config[subject]) {
							var $item = $(tpl.replace('$subject', subject).replace('$type', item).replace('$name', config[subject][item]['name']));
							$item.appendTo($(el));
						}
					});
				}

				function updateTotal() {
					var start = Date.parse($('#start').val()) || 0;
					var end = Date.parse($('#end').val()) || 0;
					if (start && end && end>=start) {
						total = (end - start) / (24*60*60*1000) + 1;
						$('.total').text(total);
					} else {
						total = 0;
						$('.total').text('?');
					}
				}

				function updateTime(el) {
					var parent = el.data('type');
					var item = {};
					var cost = 0;
					if (total && el.is(':checked')) {
						try {
							item = config[parent][el.attr('class')];
						} catch (e) {
							console.warn('unknown item');
						}
						if (item['freq']) {
							cost = Math.ceil(item['time'] * total / item['freq']) || 0;
						} else {
							cost = item['time'] || 0;
						}
						el.parent().siblings('span').text(cost+'小时').show();
					} else {
						el.parent().siblings('span').text('').hide();
					}
					return cost;
				}

				function updateAllTime() {
					$('.item input[type=checkbox]:checked').each(function(index, el) {
						updateTime($(el));
					});
				}

				function updateRemain() {
					if (!total) { 
						$('.days').text('?');
						$('.hours').text('?');
						$('.numerator').text('?');
						return; 
					}
					var cost = 0;
					var remain = 24 * total;
					$('.item input[type=checkbox]:checked').each(function(index, el) {
						cost += updateTime($(el));
					});
					remain = remain - cost;
					if (remain < 0) {
						remain = 0;
					}
					var hours = remain % 24;
					var days = (remain - hours) / 24;
					$('.days').text(days);
					$('.hours').text(hours);
					if (hours) { days++; }
					$('.numerator').text(days);
				}

				init();
				$('a, input, .page label, #dtBox').on('touchstart', function(event){
					$(event.target)[0].focus();
					$(event.target)[0].click();
					event.preventDefault();
					event.stopPropagation();
					return false;
				});
				$('.pagewrapper').on('touchstart', function(event) {
					event.preventDefault();
					if (!startX) {
						var touch = event.originalEvent.touches[0];
						startX = touch.pageX;
					}
				});
				$('.pagewrapper').on('touchmove', function(event) {
					event.preventDefault();
					if (!startX) { return false; }
					var touch = event.originalEvent.touches[0];
					offsetX = touch.pageX - startX;
					offset += offsetX;
					startX = touch.pageX;
					$(".pagewrapper").css('left', '+='+offsetX);
				});
				$('.pagewrapper').on('touchend', function(event) {
					event.preventDefault();
					if (!startX) { return false; }
					var touch = event.originalEvent.touches[0];
					var current = $('.current');
					var next = current;

					if (Math.abs(offset) <= Math.abs(offsetX)) {
						offsetX = 0;
					}

					if (offsetX < 0) {
						next = current.next();
						next = next.length === 1 ? next : current;
					} else if (offsetX > 0) {
						next = current.prev();
						next = next.length === 1 ? next : current;
					}
					var index = $('.page').index(next);
					var left = index * width;
					current.removeClass('current');
					next.addClass('current');
					if (next.hasClass('result')) {
						updateRemain();
					} else if (next.hasClass('arrangement')) {
						updateAllTime();
					}
					$('.pagewrapper').animate({
						left: -left
					}, 'fast');
					startX = 0;
					offset = 0;
				});
			});
		</script>
	</body>
</html>